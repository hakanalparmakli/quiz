<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Aile Quiz Oyunu</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
*{user-select:none;-webkit-user-select:none;-webkit-touch-callout:none;touch-action:none}
body{margin:0;background:#000;color:#fff;font-family:Arial, sans-serif;overflow:hidden}
#setup,#overlay,#nameScreen,#mobile{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center}
#setup,#overlay{z-index:10}
#overlay{display:none;background:rgba(0,0,0,0.9);padding:20px;border-radius:10px;}
#qrcode{background:#fff;padding:20px;border-radius:10px;margin-bottom:20px}
#playerCount,#order{font-size:20px;margin-top:10px}
#mobile{display:none;background:#000}
.pad{display:grid;grid-template-columns:1fr 1fr;gap:10px;width:90%;margin-top:20px}
.btn{font-size:35px;border:2px solid #fff;border-radius:15px;padding:20px;color:#fff;background:rgba(255,255,255,0.1)}
#lock{position:absolute;inset:0;display:flex;justify-content:center;align-items:center;background:rgba(0,0,0,.7);font-size:40px;color:#fff;z-index:5}
button{font-size:25px;padding:10px;margin:10px}
#questionText{font-size:30px;margin-top:20px}
#timer{font-size:25px;margin-top:10px}
#results{font-size:20px;margin-top:10px}
</style>
</head>
<body>

<div id="setup">
  <h1>Aile Quiz Oyunu</h1>
  <div id="qrcode"></div>
  <div id="playerCount">Oyuncular: 0</div>
  <div id="order"></div>
  <button id="newRoundBtn">Yeni Tur Başlat</button>
  <div id="questionText"></div>
  <div id="timer"></div>
  <div id="results"></div>
</div>

<div id="overlay"></div>

<div id="nameScreen" style="display:none">
  <h1>Aile Quiz Oyunu</h1>
  <h2>İsmini Gir</h2>
  <input id="playerName">
  <button id="joinBtn">KATIL</button>
</div>

<div id="mobile">
  <div id="lock">Sıranı Bekle</div>
  <div class="pad">
    <div id="A" class="btn">A</div>
    <div id="B" class="btn">B</div>
    <div id="C" class="btn">C</div>
    <div id="D" class="btn">D</div>
  </div>
</div>

<script>
document.addEventListener("contextmenu", e=>e.preventDefault());
const setup = document.getElementById("setup");
const overlay = document.getElementById("overlay");
const playerCount = document.getElementById("playerCount");
const order = document.getElementById("order");
const nameScreen = document.getElementById("nameScreen");
const mobile = document.getElementById("mobile");
const playerName = document.getElementById("playerName");
const joinBtn = document.getElementById("joinBtn");
const newRoundBtn = document.getElementById("newRoundBtn");
const questionText = document.getElementById("questionText");
const timerDiv = document.getElementById("timer");
const resultsDiv = document.getElementById("results");
const qrcodeDiv = document.getElementById("qrcode");

let peer = new Peer();
const params = new URLSearchParams(location.search);
const peerId = params.get("peer");

let players=[],questions=[],currentQ=0,answers={},countdownTimer;

const allQuestions=[
  {q:"Türkiye'nin başkenti?", options:["İstanbul","Ankara","İzmir","Bursa"], answer:"Ankara"},
  {q:"En büyük gezegen?", options:["Mars","Jüpiter","Venüs","Merkür"], answer:"Jüpiter"},
  {q:"Renklerden hangisi gökyüzü rengidir?", options:["Mavi","Kırmızı","Yeşil","Siyah"], answer:"Mavi"},
  {q:"2+2 kaç eder?", options:["3","4","5","6"], answer:"4"},
  {q:"Hangisi bir meyvedir?", options:["Elma","Havuç","Patates","Lahana"], answer:"Elma"}
];

function shuffle(a){return a.sort(()=>0.5-Math.random());}

/* ================= HOST ================= */
if(!peerId){

peer.on("open",id=>{
  let url=new URL(location.href);
  url.searchParams.set("peer",id);
  new QRCode(qrcodeDiv,{text:url.toString(),width:250,height:250});
});

peer.on("connection",c=>{
  c.on("data",d=>{
    if(d.type==="join"){
      players.push({peer:c.peer,name:d.name,score:0});
      playerCount.innerText=`Oyuncular: ${players.length}`;
      renderOrder();
    }
    if(d.type==="answer"){
      answers[d.peer]=d.answer;
      if(Object.keys(answers).length>=players.length){
        endQuestion();
      }
    }
  });
});

function renderOrder(){
  order.innerHTML="<h2>Skor Tablosu</h2>"+players.map(p=>`${p.name}: ${p.score}`).join("<br>");
}

function sendQuestion(){
  // QR kod ve Yeni Tur butonunu gizle
  qrcodeDiv.style.display="none";
  newRoundBtn.style.display="none";
  resultsDiv.innerHTML="";

  answers={};
  let question = questions[currentQ];
  players.forEach(p=>{
    const conn = peer.connections[p.peer]?.[0];
    if(conn) conn.send({type:"question",question});
  });
  questionText.innerText = question.q;
  timerDiv.innerText = "20 saniye";
  let time=20;
  clearInterval(countdownTimer);
  countdownTimer = setInterval(()=>{
    time--;
    timerDiv.innerText = time+" saniye";
    if(time<=0) endQuestion();
  },1000);
}

function endQuestion(){
  clearInterval(countdownTimer);
  const correct = questions[currentQ].answer;
  resultsDiv.innerHTML="<h3>Sonuçlar:</h3>";
  players.forEach(p=>{
    const ans = answers[p.peer] || "Hiç cevap yok";
    const isCorrect = ans===correct;
    if(isCorrect) p.score++;
    resultsDiv.innerHTML += `${p.name}: ${ans} ${isCorrect?"✅":"❌"}<br>`;
  });
  renderOrder();
  currentQ++;
  if(currentQ<questions.length){
    setTimeout(sendQuestion,3000);
  }else{
    overlay.innerHTML="<h1>Tur Bitti!</h1>";
    overlay.style.display="flex";
    // QR kod ve Yeni Tur butonunu tekrar göster
    qrcodeDiv.style.display="block";
    newRoundBtn.style.display="block";
  }
}

function newRound(){
  questions = shuffle(allQuestions);
  currentQ=0;
  overlay.style.display="none";
  sendQuestion();
}

newRoundBtn.addEventListener("click",newRound);

/* ================= MOBILE ================= */
}else{
setup.style.display="none";
nameScreen.style.display="flex";

peer.on("open",()=>{
  const conn=peer.connect(peerId);

  const sendJoin=()=>{
    const name=playerName.value.trim();
    if(!name) return alert("Lütfen isim girin");
    conn.send({type:"join",name,peer:peer.id});
    nameScreen.style.display="none";
    mobile.style.display="flex";
  };

  joinBtn.addEventListener("click",sendJoin);
  joinBtn.addEventListener("touchstart",e=>{ e.preventDefault(); sendJoin(); },{passive:false});

  conn.on("data",d=>{
    if(d.type==="question"){
      showQuestion(d.question,conn);
      document.getElementById("lock").style.display="none";
    }
  });

  ["A","B","C","D"].forEach(k=>{
    const el=document.getElementById(k);
    el.addEventListener("touchstart",e=>{
      e.preventDefault();
      if(document.getElementById("lock").style.display==="none"){
        conn.send({type:"answer",answer:k,peer:peer.id});
        document.getElementById("lock").style.display="flex";
      }
    },{passive:false});
  });
});

function showQuestion(q,conn){
  ["A","B","C","D"].forEach((k,i)=>{
    const el=document.getElementById(k);
    el.innerText = `${k}. ${q.options[i]}`;
  });
}
}
</script>
</body>
</html>
